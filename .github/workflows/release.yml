name: Release

on:
  workflow_dispatch:
    inputs:
      dry_run:
        description: 'Dry run (skip upload to release)'
        required: false
        default: false
        type: boolean
      tag:
        description: 'Tag to release'
        required: true
        type: string

permissions:
  contents: write

env:
  # Public URL of your R2 bucket (custom domain or r2.dev URL)
  APP_HOST: ${{ secrets.APP_HOST }}
  GIT_TAG: ${{ github.event.inputs.tag }}

jobs:
  build:
    strategy:
      fail-fast: false
      matrix:
        include:
          - os: macos-latest
            arch: arm64
            platform: darwin
          - os: macos-15-intel
            arch: x64
            platform: darwin
          - os: windows-latest
            arch: x64
            platform: win32

    runs-on: ${{ matrix.os }}
    env:
      npm_config_arch: ${{ matrix.arch }}
    outputs:
      version: ${{ steps.version.outputs.version }}

    steps:
      - name: Checkout
        uses: actions/checkout@v6
        with:
          repository: frostming/vocab
          token: ${{ secrets.VOKABRY_PAT }}

      - name: Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: 10

      - name: Setup Node.js
        uses: actions/setup-node@v6
        with:
          node-version: lts/*
          cache: pnpm

      - name: Import Apple certificate
        if: runner.os == 'macOS'
        env:
          APPLE_CERTIFICATE: ${{ secrets.APPLE_CERTIFICATE }}
          APPLE_CERTIFICATE_PASSWORD: ${{ secrets.APPLE_CERTIFICATE_PASSWORD }}
        run: |
          CERTIFICATE_PATH=$RUNNER_TEMP/build_certificate.p12
          KEYCHAIN_PATH=$RUNNER_TEMP/app-signing.keychain-db
          KEYCHAIN_PASSWORD=$(openssl rand -base64 32)

          # Decode certificate
          echo -n "$APPLE_CERTIFICATE" | base64 --decode -o $CERTIFICATE_PATH

          # Create temporary keychain
          security create-keychain -p "$KEYCHAIN_PASSWORD" $KEYCHAIN_PATH
          security set-keychain-settings -lut 21600 $KEYCHAIN_PATH
          security unlock-keychain -p "$KEYCHAIN_PASSWORD" $KEYCHAIN_PATH

          # Import certificate
          security import $CERTIFICATE_PATH -P "$APPLE_CERTIFICATE_PASSWORD" -A -t cert -f pkcs12 -k $KEYCHAIN_PATH
          security set-key-partition-list -S apple-tool:,apple: -k "$KEYCHAIN_PASSWORD" $KEYCHAIN_PATH
          security list-keychain -d user -s $KEYCHAIN_PATH

      - name: Install dependencies
        run: pnpm install

      - name: Rebuild native modules
        run: pnpm exec electron-rebuild -w better-sqlite3

      - name: Build and make
        run: pnpm make -- --arch=${{ matrix.arch }}
        env:
          APP_HOST: ${{ env.APP_HOST }}
          APTABASE_APP_KEY: ${{ secrets.APTABASE_APP_KEY }}
          APTABASE_HOST: ${{ secrets.APTABASE_HOST }}
          # Code signing for macOS
          APPLE_ID: ${{ secrets.APPLE_ID }}
          APPLE_PASSWORD: ${{ secrets.APPLE_PASSWORD }}
          APPLE_TEAM_ID: ${{ secrets.APPLE_TEAM_ID }}
          DEBUG: electron-forge:*

      - name: Get version
        id: version
        shell: bash
        run: |
          VERSION=$(node -p "require('./package.json').version")
          echo "version=$VERSION" >> $GITHUB_OUTPUT

      - name: Prepare artifacts (macOS)
        if: runner.os == 'macOS'
        run: |
          PLATFORM_DIR="${{ matrix.platform }}/${{ matrix.arch }}"
          mkdir -p "artifacts/$PLATFORM_DIR"

          # Copy zip for auto-update
          find out/make -name "*.zip" -exec cp {} "artifacts/$PLATFORM_DIR/" \;
          find out/make -name "*.dmg" -exec cp {} "artifacts/$PLATFORM_DIR/" \;
          # Copy RELEASES.json for auto-update
          find out/make -name "RELEASES.json" -exec cp {} "artifacts/$PLATFORM_DIR/" \;

          echo "Artifacts:"
          ls -la "artifacts/$PLATFORM_DIR/"

      - name: Prepare artifacts (Windows)
        if: runner.os == 'Windows'
        shell: bash
        run: |
          PLATFORM_DIR="${{ matrix.platform }}/${{ matrix.arch }}"
          mkdir -p "artifacts/$PLATFORM_DIR"

          # Copy Squirrel files for auto-update (to R2)
          find out/make -name "*.nupkg" -exec cp {} "artifacts/$PLATFORM_DIR/" \;
          find out/make -name "RELEASES" -exec cp {} "artifacts/$PLATFORM_DIR/" \;
          find out/make -name "*Setup*.exe" -exec cp {} "artifacts/$PLATFORM_DIR/" \;

          echo "Artifacts:"
          ls -la "artifacts/$PLATFORM_DIR/"

      - name: Upload Artifacts
        uses: actions/upload-artifact@v6
        with:
          name: r2-${{ matrix.platform }}-${{ matrix.arch }}
          path: artifacts/
          if-no-files-found: error

  publish:
    needs: build
    runs-on: ubuntu-latest
    if: "!inputs.dry_run"

    steps:
      - name: Download Artifacts
        uses: actions/download-artifact@v7
        with:
          pattern: r2-*
          path: r2-artifacts
          merge-multiple: true

      - name: Make latest.json
        run: |
          set -euo pipefail

          quote_url() {
            python3 -c 'import sys, urllib.parse; print(urllib.parse.quote(sys.argv[1]))' "$1"
          }

          MAC_ARM_DMG="$(find r2-artifacts/darwin/arm64 -maxdepth 1 -type f -name '*.dmg' -print -quit)"
          MAC_X64_DMG="$(find r2-artifacts/darwin/x64 -maxdepth 1 -type f -name '*.dmg' -print -quit)"
          WIN_SETUP_EXE="$(find r2-artifacts/win32/x64 -maxdepth 1 -type f \( -iname '*setup*.exe' -o -iname '*Setup*.exe' \) -print -quit)"

          if [[ -z "${MAC_ARM_DMG}" || -z "${MAC_X64_DMG}" || -z "${WIN_SETUP_EXE}" ]]; then
            echo "Missing expected artifacts:"
            echo "  darwin/arm64 dmg: ${MAC_ARM_DMG:-<missing>}"
            echo "  darwin/x64 dmg:   ${MAC_X64_DMG:-<missing>}"
            echo "  win32/x64 exe:    ${WIN_SETUP_EXE:-<missing>}"
            exit 1
          fi

          MAC_ARM_NAME="$(basename "$MAC_ARM_DMG")"
          MAC_X64_NAME="$(basename "$MAC_X64_DMG")"
          WIN_SETUP_NAME="$(basename "$WIN_SETUP_EXE")"

          MAC_ARM_URL="${APP_HOST}/darwin/arm64/$(quote_url "$MAC_ARM_NAME")"
          MAC_X64_URL="${APP_HOST}/darwin/x64/$(quote_url "$MAC_X64_NAME")"
          WIN_SETUP_URL="${APP_HOST}/win32/x64/$(quote_url "$WIN_SETUP_NAME")"

          cat > r2-artifacts/latest.json << EOF
          {
            "version": "${{ needs.build.outputs.version }}",
            "urls": {
              "darwin/arm64": "$MAC_ARM_URL",
              "darwin/x64": "$MAC_X64_URL",
              "win32/x64": "$WIN_SETUP_URL"
            }
          }
          EOF

          echo "Wrote r2-artifacts/latest.json:"
          cat r2-artifacts/latest.json

      - name: Display artifact structure
        run: |
          echo "=== R2 artifacts (for auto-update) ==="
          find r2-artifacts -type f

      - name: Upload to Cloudflare R2
        uses: ryand56/r2-upload-action@latest
        with:
          r2-account-id: ${{ secrets.R2_ACCOUNT_ID }}
          r2-access-key-id: ${{ secrets.R2_ACCESS_KEY_ID }}
          r2-secret-access-key: ${{ secrets.R2_SECRET_ACCESS_KEY }}
          r2-bucket: ${{ secrets.R2_BUCKET_NAME }}
          source-dir: r2-artifacts
          destination-dir: ./

  release-github:
    needs: build
    runs-on: ubuntu-latest
    if: "!inputs.dry_run"

    steps:
      - uses: actions/checkout@v6
        with:
          repository: frostming/vocab
          token: ${{ secrets.VOKABRY_PAT }}
          fetch-depth: 0

      - name: Download Artifacts
        uses: actions/download-artifact@v7
        with:
          pattern: r2-*
          path: artifacts
          merge-multiple: true

      - name: Prepare GitHub Release artifacts
        run: |
          mkdir -p github-release
          find artifacts -type f \( -iname '*.dmg' -o -iname '*Setup*.exe' -o -iname '*setup*.exe' \) -exec cp {} github-release/ \;
          echo "=== GitHub Release artifacts ==="
          find github-release -type f

      - name: Setup node
        uses: actions/setup-node@v6
        with:
          node-version: lts/*

      - name: Generate Release Notes
        run: |
          npx changelogithub --output /tmp/release_notes.md

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          files: github-release/*
          body_path: /tmp/release_notes.md
          tag_name: ${{ env.GIT_TAG }}
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
